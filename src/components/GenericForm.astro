---
import { resolveFormTemplate, isValidTemplate } from '../config/formTemplates';
import { TURNSTILE_SITE_KEY } from '../config/turnstile';

export interface Props {
  formData: {
    slug: string;
    formTemplate?: 'application' | 'download' | 'contact' | 'campSignup';
    ageThreshold?: number; // Age threshold for guardian requirement (default: 14)
    form: {
      title: string;
      subtitle?: string;
      action?: string;
      fields?: Array<{
        type: 'text' | 'email' | 'select' | 'textarea' | 'checkbox' | 'radio' | 'date';
        name: string;
        label: string;
        placeholder?: string;
        required: boolean;
        options?: Array<{
          value: string;
          label: string;
        }>;
        hint?: string;
      }>;
      submitButton?: {
        default: string;
        loading: string;
      };
      confirmationMessage?: string;
    };
  };
  locale: 'en' | 'es';
}

const { formData, locale } = Astro.props;

// Calculate redirect path (will be made absolute at runtime)
const redirectPath = `/${locale === 'es' ? 'es/' : ''}form/${formData.slug}/thank-you/`;

// Define the complete form type
type ResolvedForm = {
  title: string;
  subtitle?: string;
  action: string;
  fields: Array<{
    type: 'text' | 'email' | 'select' | 'textarea' | 'checkbox' | 'radio' | 'date';
    name: string;
    label: string;
    placeholder?: string;
    required: boolean;
    options?: Array<{
      value: string;
      label: string;
    }>;
    hint?: string;
  }>;
  submitButton: {
    default: string;
    loading: string;
  };
  confirmationMessage?: string;
};

// Get age threshold (default to 14 for backward compatibility)
const ageThreshold = formData.ageThreshold ?? 14;

// Resolve form configuration - either from template or direct config
let resolvedForm: ResolvedForm;

if (formData.formTemplate && isValidTemplate(formData.formTemplate)) {
  // Use template resolution
  const template = resolveFormTemplate(formData.formTemplate, locale);
  resolvedForm = {
    title: formData.form.title,
    subtitle: formData.form.subtitle,
    action: formData.form.action || template.action,
    fields: template.fields,
    submitButton: formData.form.submitButton || template.submitButton,
    confirmationMessage: formData.form.confirmationMessage || template.confirmationMessage
  };
} else {
  // Use direct form configuration - ensure required fields are present
  if (!formData.form.fields || !formData.form.submitButton || !formData.form.action) {
    throw new Error(`Form "${formData.slug}" must either use a formTemplate or provide complete form configuration (fields, submitButton, action)`);
  }
  resolvedForm = formData.form as ResolvedForm;
}

const form = resolvedForm;
---

<section class="form-section">
  <div class="container">
    <div class="form-container">
      <div class="form-wrapper">
        <h1 class="form-title">{form.title}</h1>
        {form.subtitle && <p class="form-subtitle">{form.subtitle}</p>}

        <form
          id={`form-${formData.slug}`}
          action={form.action}
          method="POST"
          class="form"
          accept-charset="UTF-8"
          enctype="application/x-www-form-urlencoded"
        >
          <!-- Hidden field to identify form type -->
          <input type="hidden" name="formType" value={formData.slug} />

          <!-- Formspark redirect URL (will be set by JavaScript) -->
          <input type="hidden" name="_redirect" id={`redirect-${formData.slug}`} value="" />

          <!-- Honeypot (anti-spam, Formspark rejects if filled) -->
          <input type="text" name="_honeypot" style="display:none" tabindex="-1" autocomplete="off" />

          <!-- Guardian Notification (shown dynamically for under-14 students) -->
          <div id="guardian-notification" class="guardian-notification" style="display: none;">
            <div class="notification-icon">‚ÑπÔ∏è</div>
            <div class="notification-content">
              <p class="notification-title" id="notification-title"></p>
              <p class="notification-message" id="notification-message"></p>
            </div>
          </div>

          {form.fields.filter(f => f.type !== 'checkbox').map((field) => (
            <div class="form-group">
              {field.type === 'select' ? (
                <!-- Select Field -->
                <>
                  <label for={field.name} class="form-label">
                    {field.label}
                    {field.required && <span class="required">*</span>}
                  </label>
                  <select
                    id={field.name}
                    name={field.name}
                    class="form-input form-select"
                    required={field.required}
                  >
                    <option value="" disabled selected>
                      {field.placeholder}
                    </option>
                    {field.options?.map((option) => (
                      <option value={option.value}>
                        {option.label}
                      </option>
                    ))}
                  </select>
                </>
              ) : field.type === 'textarea' ? (
                <!-- Textarea Field -->
                <>
                  <label for={field.name} class="form-label">
                    {field.label}
                    {field.required && <span class="required">*</span>}
                  </label>
                  <textarea
                    id={field.name}
                    name={field.name}
                    class="form-input form-textarea"
                    placeholder={field.placeholder}
                    required={field.required}
                    rows="4"
                  ></textarea>
                </>
              ) : field.type === 'radio' ? (
                <!-- Radio Button Field -->
                <div class="radio-group">
                  <label class="form-label">
                    {field.label}
                    {field.required && <span class="required">*</span>}
                  </label>
                  <div class="radio-options">
                    {field.options?.map((option) => (
                      <label class="radio-label">
                        <input
                          type="radio"
                          name={field.name}
                          value={option.value}
                          required={field.required}
                        />
                        <span class="radio-text">{option.label}</span>
                      </label>
                    ))}
                  </div>
                </div>
              ) : field.type === 'date' ? (
                <!-- Date Field with enhanced UX -->
                <>
                  <label for={field.name} class="form-label">
                    {field.label}
                    {field.required && <span class="required">*</span>}
                  </label>
                  <div class="date-input-container">
                    <input
                      type="date"
                      id={field.name}
                      name={field.name}
                      class="form-input date-input"
                      required={field.required}
                    />
                    <span class="date-placeholder" data-date-for={field.name}>
                      {locale === 'es' ? 'dd/mm/aaaa' : 'dd/mm/yyyy'}
                    </span>
                  </div>
                </>
              ) : (
                <!-- Text/Email Fields -->
                <>
                  <label for={field.name} class="form-label">
                    {field.label}
                    {field.required && <span class="required">*</span>}
                  </label>
                  <input
                    type={field.type}
                    id={field.name}
                    name={field.name}
                    class="form-input"
                    placeholder={field.placeholder}
                    required={field.required}
                  />
                  {field.hint && (
                    <div class="field-hint">
                      <span class="hint-icon">üí°</span>
                      <span class="hint-text">{field.hint}</span>
                    </div>
                  )}
                </>
              )}
            </div>
          ))}

          <!-- Cloudflare Turnstile (anti-bot) -->
          <div class="cf-turnstile" data-sitekey={TURNSTILE_SITE_KEY} data-theme="light"></div>

          {form.fields.filter(f => f.type === 'checkbox').map((field) => (
            <div class="form-group">
              <div class="checkbox-group">
                <label class="checkbox-label">
                  <input
                    type="checkbox"
                    id={field.name}
                    name={field.name}
                    value="yes"
                    required={field.required}
                  />
                  <span class="consent-text">
                    {field.label}
                  </span>
                  {field.required && <span class="required">*</span>}
                </label>
              </div>
            </div>
          ))}

          <!-- Confirmation Message -->
          {form.confirmationMessage && (
            <div class="form-group">
              <p class="confirmation-message">
                {form.confirmationMessage}
              </p>
            </div>
          )}

          <!-- Submit Button -->
          <div class="form-group">
            <button type="submit" class="submit-button">
              {form.submitButton.default}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</section>

<style>
  .form-section {
    padding: var(--space-xl) var(--section-inline);
    background: var(--background-primary);
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .container {
    max-width: var(--max-width);
    margin: 0 auto;
  }

  .form-container {
    max-width: 500px;
    margin: 0 auto;
  }

  .form-wrapper {
    background: var(--background-elevated);
    border-radius: 12px;
    padding: 2rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    border: 1px solid var(--border-primary);
  }

  .form-title {
    font-size: 1.75rem;
    font-weight: 700;
    margin-bottom: 1.5rem;
    color: var(--text-primary);
    text-align: center;
  }

  .form-subtitle {
    font-size: var(--font-size-base);
    font-weight: var(--font-weight-light);
    color: var(--text-secondary);
    margin-bottom: 2rem;
    text-align: center;
    line-height: 1.6;
  }

  .form {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .form-label {
    font-weight: 600;
    color: var(--text-primary);
    font-size: 0.95rem;
  }

  .required {
    color: #ef4444 !important;
    margin-left: 0.25rem;
  }

  .form-input,
  .form-select,
  .form-textarea {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid var(--border-primary);
    border-radius: 6px;
    font-size: 1rem;
    background: var(--background-primary);
    color: var(--text-primary);
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  .form-input:focus,
  .form-select:focus,
  .form-textarea:focus {
    outline: none;
    border-color: #0066cc;
    box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
  }

  .form-input::placeholder,
  .form-textarea::placeholder {
    color: #6b7280;
    font-weight: 400;
  }

  .form-select {
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
    background-position: right 0.75rem center;
    background-repeat: no-repeat;
    background-size: 1.5rem;
    padding-right: 2.5rem;
  }

  .form-select option[value=""][disabled] {
    color: #9ca3af;
  }

  .form-textarea {
    resize: vertical;
    min-height: 100px;
  }

  .field-hint {
    display: flex;
    align-items: flex-start;
    gap: 0.5rem;
    padding: 0.625rem 0.75rem;
    background: #fef3c7;
    border: 1px solid #fcd34d;
    border-radius: 6px;
    margin-top: 0.5rem;
  }

  .hint-icon {
    flex-shrink: 0;
    font-size: 1rem;
    line-height: 1.4;
  }

  .hint-text {
    font-size: 0.875rem;
    line-height: 1.4;
    color: #92400e;
  }

  /* Date Input Enhancements */
  .date-input-container {
    position: relative;
  }

  .date-input {
    position: relative;
    cursor: pointer;
    font-variant-numeric: tabular-nums;
    letter-spacing: 0.01em;
    min-height: 44px; /* iOS minimum tap target */
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
  }

  .date-placeholder {
    position: absolute;
    left: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    color: #6b7280;
    pointer-events: none;
    font-size: 1rem;
    transition: opacity 0.2s;
  }

  .date-input:focus + .date-placeholder,
  .date-input:valid + .date-placeholder,
  .date-input.has-value + .date-placeholder {
    opacity: 0;
  }

  /* Desktop date input styles */
  @media (min-width: 769px) {
    .date-input {
      cursor: text;
    }

    /* Hide custom placeholder on desktop - native input handles it */
    .date-placeholder {
      display: none;
    }

    .date-input::-webkit-calendar-picker-indicator {
      cursor: pointer;
      padding: 0.25rem;
      margin-left: 0.5rem;
      opacity: 0.7;
      transition: opacity 0.2s;
    }

    .date-input::-webkit-calendar-picker-indicator:hover {
      opacity: 1;
      background-color: rgba(0, 102, 204, 0.1);
      border-radius: 4px;
    }
  }

  /* Mobile iOS optimizations */
  @media (max-width: 768px) {
    .date-input {
      font-size: 16px; /* Prevent zoom on iOS */
      -webkit-appearance: none;
      appearance: none;
      background-color: var(--background-primary);
    }

    .date-input::-webkit-date-and-time-value {
      text-align: left;
    }
  }

  .date-input::-webkit-datetime-edit-fields-wrapper {
    padding: 0;
  }

  .date-input::-webkit-datetime-edit-text {
    padding: 0 0.125rem;
  }

  .date-input::-webkit-datetime-edit {
    padding: 0;
  }

  .date-input:focus {
    outline: none;
    border-color: #0066cc;
    box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
  }

  .checkbox-group {
    margin: 1rem 0;
  }

  .checkbox-label {
    display: flex;
    align-items: flex-start;
    cursor: pointer;
    font-size: 0.95rem;
    color: var(--text-primary);
  }

  .checkbox-label input[type="checkbox"] {
    margin-right: 0.75rem;
    margin-top: 0.125rem;
    width: 1.25rem;
    height: 1.25rem;
    cursor: pointer;
    accent-color: #0066cc;
  }

  .checkbox-label .consent-text {
    flex: 1;
    line-height: 1.5;
  }

  .checkbox-label .consent-text .privacy-link {
    color: #0066cc;
    text-decoration: underline;
    transition: color 0.2s;
  }

  .checkbox-label .consent-text .privacy-link:hover {
    color: #0052a3;
  }

  .radio-group {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .radio-options {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .radio-label {
    display: flex;
    align-items: center;
    cursor: pointer;
    padding: 0.75rem 1rem;
    border: 1px solid var(--border-primary);
    border-radius: 6px;
    background: var(--background-primary);
    transition: border-color 0.2s, background-color 0.2s;
  }

  .radio-label:hover {
    border-color: #0066cc;
    background: rgba(0, 102, 204, 0.02);
  }

  .radio-label input[type="radio"] {
    margin-right: 0.75rem;
    width: 1.125rem;
    height: 1.125rem;
    cursor: pointer;
    accent-color: #0066cc;
  }

  .radio-label input[type="radio"]:checked + .radio-text {
    font-weight: 600;
    color: #0066cc;
  }

  .radio-label:has(input[type="radio"]:checked) {
    border-color: #0066cc;
    background: rgba(0, 102, 204, 0.05);
  }

  .radio-text {
    flex: 1;
    line-height: 1.5;
    color: var(--text-primary);
    transition: color 0.2s, font-weight 0.2s;
  }

  .guardian-notification {
    display: flex;
    gap: 0.75rem;
    padding: 1rem;
    background: #dbeafe;
    border: 1px solid #93c5fd;
    border-radius: 8px;
    margin-bottom: 1.5rem;
  }

  .notification-icon {
    font-size: 1.5rem;
    flex-shrink: 0;
  }

  .notification-content {
    flex: 1;
  }

  .notification-title {
    font-weight: 600;
    color: #1e40af;
    margin: 0 0 0.25rem 0;
    font-size: 0.95rem;
  }

  .notification-message {
    color: #1e3a8a;
    font-size: 0.9rem;
    line-height: 1.5;
    margin: 0;
  }

  .confirmation-message {
    color: var(--text-secondary);
    font-size: 0.9rem;
    line-height: 1.5;
    padding: 1rem;
    background: #f3f4f6;
    border-radius: 6px;
    border: 1px solid #e5e7eb;
  }

  .submit-button {
    width: 100%;
    padding: 0.875rem 1.5rem;
    background: #0066cc;
    color: white;
    font-weight: 600;
    font-size: 1rem;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.2s, transform 0.1s;
  }

  .submit-button:hover {
    background: #0052a3;
    transform: translateY(-1px);
  }

  .submit-button:active {
    transform: translateY(0);
  }

  .submit-button:disabled {
    background: #9ca3af;
    cursor: not-allowed;
    transform: none;
  }

  /* Mobile Responsiveness */
  @media (max-width: 768px) {
    .form-section {
      padding: var(--space-l) var(--section-inline);
    }

    .form-wrapper {
      padding: 1.5rem;
    }

    .form-input,
    .form-select,
    .form-textarea {
      font-size: 16px; /* Prevents zoom on iOS */
    }
  }
</style>

<script define:vars={{ formData, form, locale, redirectPath, ageThreshold }}>
  // Handle form submission with runtime redirect URL
  document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ GenericForm script loaded for form:', formData.slug);
    const formElement = document.getElementById(`form-${formData.slug}`);
    const redirectField = document.getElementById(`redirect-${formData.slug}`);

    if (!formElement) {
      console.error('üöÄ Form element not found:', `form-${formData.slug}`);
      return;
    }

    if (!redirectField) {
      console.error('üöÄ Redirect field not found:', `redirect-${formData.slug}`);
      return;
    }

    // Build absolute redirect URL using current origin
    const redirectUrl = `${window.location.origin}${redirectPath}`;
    redirectField.value = redirectUrl;

    console.log('üöÄ Form element found:', formElement);
    console.log('üöÄ Form action URL:', formElement.action);
    console.log('üöÄ Redirect URL set to:', redirectUrl);

    // === Conditional Form Logic ===
    // Get field groups
    const getFieldGroup = (fieldName) => {
      const input = formElement.querySelector(`[name="${fieldName}"]`);
      return input?.closest('.form-group');
    };

    const roleGroup = getFieldGroup('role');
    const signUpForGroup = getFieldGroup('signUpFor');
    const birthdateGroup = getFieldGroup('birthdate');
    const participantAgeGroup = getFieldGroup('participantAge'); // For backward compatibility
    const guardianNameGroup = getFieldGroup('guardianName');
    const guardianEmailGroup = getFieldGroup('guardianEmail');
    const campPricingGroup = getFieldGroup('campPricing');

    // Determine which age field is present (birthdate or participantAge for backward compatibility)
    const ageFieldGroup = birthdateGroup || participantAgeGroup;
    const useBirthdate = !!birthdateGroup;

    // Debug: Check if all fields exist
    console.log('üìã Field groups found:', {
      roleGroup: !!roleGroup,
      signUpForGroup: !!signUpForGroup,
      ageFieldGroup: !!ageFieldGroup,
      useBirthdate,
      guardianNameGroup: !!guardianNameGroup,
      guardianEmailGroup: !!guardianEmailGroup,
      campPricingGroup: !!campPricingGroup
    });
    console.log('üìã Age threshold:', ageThreshold);

    // Get labels and inputs for dynamic updates
    const birthdateLabel = formElement.querySelector('label[for="birthdate"]');
    const fullNameLabel = formElement.querySelector('label[for="fullName"]');
    const emailLabel = formElement.querySelector('label[for="email"]');
    const schoolNameLabel = formElement.querySelector('label[for="schoolName"]');
    const fullNameInput = formElement.querySelector('input[name="fullName"]');
    const emailInput = formElement.querySelector('input[name="email"]');
    const schoolNameInput = formElement.querySelector('input[name="schoolName"]');
    const consentLabel = formElement.querySelector('input[name="consent"]')?.closest('.checkbox-label')?.querySelector('.consent-text');
    const guardianNotification = document.getElementById('guardian-notification');
    const notificationTitle = document.getElementById('notification-title');
    const notificationMessage = document.getElementById('notification-message');

    // Helper function to calculate age from birthdate
    function calculateAge(birthdate) {
      if (!birthdate) return null;
      const today = new Date();
      const birthDate = new Date(birthdate);
      let age = today.getFullYear() - birthDate.getFullYear();
      const monthDiff = today.getMonth() - birthDate.getMonth();
      if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
        age--;
      }
      return age;
    }

    // Helper function to show/hide and manage required state
    function setFieldVisibility(fieldGroup, visible, required = false) {
      if (!fieldGroup) return;

      fieldGroup.style.display = visible ? 'flex' : 'none';

      // Find input/select/textarea in the group
      const input = fieldGroup.querySelector('input:not([type="radio"]), select, textarea');
      if (input) {
        input.required = required;
        input.disabled = !visible; // Disabled fields don't submit
        if (!visible) input.value = '';
      }

      // Handle radio buttons separately
      const radioInputs = fieldGroup.querySelectorAll('input[type="radio"]');
      radioInputs.forEach(radio => {
        radio.required = required;
        radio.disabled = !visible; // Disabled fields don't submit
        if (!visible) radio.checked = false;
      });

      // Update the asterisk in the label
      const label = fieldGroup.querySelector('label.form-label, label[for]');
      if (label) {
        let asterisk = label.querySelector('.required');
        if (required && !asterisk) {
          // Add asterisk if it doesn't exist
          asterisk = document.createElement('span');
          asterisk.className = 'required';
          asterisk.style.color = '#ef4444';
          asterisk.style.marginLeft = '0.25rem';
          asterisk.textContent = ' *';
          label.appendChild(asterisk);
        } else if (!required && asterisk) {
          // Remove asterisk if it exists
          asterisk.remove();
        }
      }
    }

    // Update form display based on current selections
    function updateFormDisplay() {
      const role = formElement.querySelector('select[name="role"]')?.value;
      const signUpFor = formElement.querySelector('input[name="signUpFor"]:checked')?.value;

      // Determine effective signUpFor value:
      // - If signUpForGroup doesn't exist (camp forms), treat parent as signing up child
      // - Otherwise use the actual signUpFor value
      const effectiveSignUpFor = !signUpForGroup && role === 'parent' ? 'my-child' : signUpFor;

      // Get age information - either from birthdate or participantAge (backward compatibility)
      let isUnderThreshold = false;
      let ageValue = null;

      if (useBirthdate) {
        // Modern approach: Use birthdate
        const birthdateInput = formElement.querySelector('input[name="birthdate"]');
        const birthdate = birthdateInput?.value;
        ageValue = calculateAge(birthdate);
        isUnderThreshold = ageValue !== null && ageValue < ageThreshold;
        console.log('üîÑ Update form display (birthdate):', { role, signUpFor, effectiveSignUpFor, birthdate, ageValue, ageThreshold, isUnderThreshold });
      } else {
        // Legacy approach: Use participantAge radio buttons
        const participantAge = formElement.querySelector('input[name="participantAge"]:checked')?.value;
        isUnderThreshold = participantAge === `under${ageThreshold}`;
        console.log('üîÑ Update form display (radio):', { role, signUpFor, effectiveSignUpFor, participantAge, isUnderThreshold });
      }

      // Rule 1: Show signUpFor field only if role is "parent" AND field exists
      const showSignUpFor = signUpForGroup && role === 'parent';
      console.log('  ‚Üí Rule 1 (signUpFor):', { role, showSignUpFor });
      setFieldVisibility(signUpForGroup, showSignUpFor, showSignUpFor);

      // Rule 2: Show age field (birthdate or participantAge) based on role + effectiveSignUpFor
      let showAge = false;
      if (role === 'student') {
        console.log('  ‚Üí Rule 2 (age): student = SHOW');
        showAge = true;
      } else if (role === 'parent' && effectiveSignUpFor === 'my-child') {
        console.log('  ‚Üí Rule 2 (age): parent + my-child = SHOW');
        showAge = true;
      } else {
        console.log('  ‚Üí Rule 2 (age): conditions not met = HIDE', { role, effectiveSignUpFor });
      }
      setFieldVisibility(ageFieldGroup, showAge, showAge);

      // Rule 3: Show guardian fields and notification
      let showGuardian = false;
      let showNotification = false;

      if (role === 'student' && isUnderThreshold) {
        showGuardian = true;
        showNotification = true; // Show notification for under-threshold students
      } else if (role === 'parent' && effectiveSignUpFor === 'my-child') {
        showGuardian = true;
        showNotification = false; // Don't show notification for parents signing up child
      }

      setFieldVisibility(guardianNameGroup, showGuardian, showGuardian);
      setFieldVisibility(guardianEmailGroup, showGuardian, showGuardian);

      // Show/hide guardian notification and position it correctly
      if (guardianNotification && notificationTitle && notificationMessage) {
        if (showNotification) {
          const notificationTexts = {
            en: {
              title: 'Parent/Guardian Required',
              message: `Since you are under ${ageThreshold}, a parent or guardian must complete the rest of this application on your behalf.`
            },
            es: {
              title: 'Se Requiere Padre/Madre/Tutor',
              message: `Como eres menor de ${ageThreshold} a√±os, un padre/madre o tutor debe completar el resto de esta solicitud en tu nombre.`
            }
          };
          const lang = locale || 'en';
          notificationTitle.textContent = notificationTexts[lang].title;
          notificationMessage.textContent = notificationTexts[lang].message;
          guardianNotification.style.display = 'flex';

          // Position notification between age field and guardian name
          if (ageFieldGroup && guardianNameGroup) {
            // Insert notification after the age group
            ageFieldGroup.parentNode.insertBefore(guardianNotification, guardianNameGroup);
          }
        } else {
          guardianNotification.style.display = 'none';
        }
      }

      // Rule 4: Update dynamic labels for birthdate field
      if (birthdateLabel) {
        const labels = {
          en: {
            studentBirthdate: 'Student\'s Date of Birth'
          },
          es: {
            studentBirthdate: 'Fecha de Nacimiento del Estudiante'
          }
        };
        const lang = locale || 'en';
        // Always use "Student's" terminology for consistency
        birthdateLabel.childNodes[0].textContent = labels[lang].studentBirthdate + ' ';
      }

      // Update fullName and email labels and placeholders
      if (fullNameLabel && emailLabel && fullNameInput && emailInput) {
        const nameLabels = {
          en: {
            default: 'Full Name',
            student: 'Student\'s Full Name'
          },
          es: {
            default: 'Nombre Completo',
            student: 'Nombre Completo del Estudiante'
          }
        };
        const emailLabels = {
          en: {
            default: 'Email',
            student: 'Student\'s Email'
          },
          es: {
            default: 'Correo Electr√≥nico',
            student: 'Email del Estudiante'
          }
        };
        const namePlaceholders = {
          en: {
            default: 'Enter your full name',
            student: 'Enter student\'s full name'
          },
          es: {
            default: 'Ingrese su nombre completo',
            student: 'Ingrese el nombre completo del estudiante'
          }
        };
        const emailPlaceholders = {
          en: {
            default: 'Enter your email',
            student: 'Enter student\'s email'
          },
          es: {
            default: 'Ingrese su email',
            student: 'Ingrese el email del estudiante'
          }
        };
        const lang = locale || 'en';
        // Use "Student's" when guardian is involved
        const labelKey = showGuardian ? 'student' : 'default';
        fullNameLabel.childNodes[0].textContent = nameLabels[lang][labelKey] + ' ';
        emailLabel.childNodes[0].textContent = emailLabels[lang][labelKey] + ' ';
        fullNameInput.placeholder = namePlaceholders[lang][labelKey];
        emailInput.placeholder = emailPlaceholders[lang][labelKey];
      }

      // Update schoolName placeholder
      if (schoolNameLabel && schoolNameInput) {
        const schoolPlaceholders = {
          en: {
            default: 'Enter your school name',
            student: 'Enter student\'s school name'
          },
          es: {
            default: 'Ingrese el nombre de su escuela',
            student: 'Ingrese el nombre de la escuela del estudiante'
          }
        };
        const lang = locale || 'en';
        const labelKey = showGuardian ? 'student' : 'default';
        schoolNameInput.placeholder = schoolPlaceholders[lang][labelKey];
      }

      // Update guardian field labels and placeholders
      if (showGuardian) {
        const guardianNameLabel = guardianNameGroup?.querySelector('label');
        const guardianEmailLabel = guardianEmailGroup?.querySelector('label');
        const guardianNameInput = guardianNameGroup?.querySelector('input[name="guardianName"]');
        const guardianEmailInput = guardianEmailGroup?.querySelector('input[name="guardianEmail"]');

        const labels = {
          en: {
            guardianName: 'Guardian\'s Name',
            guardianEmail: 'Guardian\'s Email'
          },
          es: {
            guardianName: 'Nombre del Tutor',
            guardianEmail: 'Email del Tutor'
          }
        };
        const placeholders = {
          en: {
            guardianName: 'Enter guardian\'s full name',
            guardianEmail: 'Enter guardian\'s email'
          },
          es: {
            guardianName: 'Ingrese el nombre completo del tutor',
            guardianEmail: 'Ingrese el email del tutor'
          }
        };
        const lang = locale || 'en';

        if (guardianNameLabel) guardianNameLabel.childNodes[0].textContent = labels[lang].guardianName + ' ';
        if (guardianEmailLabel) guardianEmailLabel.childNodes[0].textContent = labels[lang].guardianEmail + ' ';
        if (guardianNameInput) guardianNameInput.placeholder = placeholders[lang].guardianName;
        if (guardianEmailInput) guardianEmailInput.placeholder = placeholders[lang].guardianEmail;
      }

      // Update gender field label
      const genderGroup = getFieldGroup('gender');
      const genderLabel = genderGroup?.querySelector('label');
      if (genderLabel) {
        const labels = {
          en: {
            default: 'Gender',
            student: 'Student\'s Gender'
          },
          es: {
            default: 'G√©nero',
            student: 'G√©nero del Estudiante'
          }
        };
        const lang = locale || 'en';
        // Use "Student's" when guardian is involved
        const labelKey = showGuardian ? 'student' : 'default';
        genderLabel.childNodes[0].textContent = labels[lang][labelKey] + ' ';
      }

      // Update t-shirt size field label (camp forms only)
      const tshirtSizeGroup = getFieldGroup('tshirtSize');
      const tshirtSizeLabel = tshirtSizeGroup?.querySelector('label');
      if (tshirtSizeLabel) {
        const labels = {
          en: {
            default: 'T-Shirt Size',
            student: 'Student\'s T-Shirt Size'
          },
          es: {
            default: 'Talla de Camiseta',
            student: 'Talla de Camiseta del Estudiante'
          }
        };
        const lang = locale || 'en';
        // Use "Student's" when guardian is involved
        const labelKey = showGuardian ? 'student' : 'default';
        tshirtSizeLabel.childNodes[0].textContent = labels[lang][labelKey] + ' ';
      }

      // Rule 5: Update consent checkbox label based on context
      // Only apply dynamic label if form has conditional fields (signUpFor field exists OR role is parent)
      if (consentLabel && (signUpForGroup || role === 'parent')) {
        const privacyPolicyPath = locale === 'es' ? '/es/privacy/' : '/privacy/';
        const privacyPolicyText = locale === 'es' ? 'Pol√≠tica de Privacidad' : 'Privacy Policy';

        const consentTexts = {
          en: {
            default: `I agree to receive Olympiad-related emails and to the <a href="${privacyPolicyPath}" target="_blank" rel="noopener noreferrer" class="privacy-link">${privacyPolicyText}</a>`,
            guardian: `I am the legal guardian and consent to my child's participation and to both of us receiving Olympiad-related emails, as per the <a href="${privacyPolicyPath}" target="_blank" rel="noopener noreferrer" class="privacy-link">${privacyPolicyText}</a>`
          },
          es: {
            default: `Acepto recibir correos electr√≥nicos relacionados con la Olimpiada y la <a href="${privacyPolicyPath}" target="_blank" rel="noopener noreferrer" class="privacy-link">${privacyPolicyText}</a>`,
            guardian: `Soy el tutor legal y doy mi consentimiento para la participaci√≥n de mi hijo/a y para que ambos recibamos correos electr√≥nicos relacionados con la Olimpiada, seg√∫n la <a href="${privacyPolicyPath}" target="_blank" rel="noopener noreferrer" class="privacy-link">${privacyPolicyText}</a>`
          }
        };
        const lang = locale || 'en';

        // Determine which consent text to use
        let consentKey = 'default';
        if ((role === 'student' && isUnderThreshold) || (role === 'parent' && effectiveSignUpFor === 'my-child')) {
          consentKey = 'guardian';
        }

        consentLabel.innerHTML = consentTexts[lang][consentKey];
      }
    }

    // Add event listeners
    const roleSelect = formElement.querySelector('select[name="role"]');
    const signUpForRadios = formElement.querySelectorAll('input[name="signUpFor"]');
    const participantAgeRadios = formElement.querySelectorAll('input[name="participantAge"]');
    const birthdateInput = formElement.querySelector('input[name="birthdate"]');
    const campPricingRadios = formElement.querySelectorAll('input[name="campPricing"]');

    if (roleSelect) roleSelect.addEventListener('change', updateFormDisplay);
    signUpForRadios.forEach(radio => radio.addEventListener('change', updateFormDisplay));
    participantAgeRadios.forEach(radio => radio.addEventListener('change', updateFormDisplay));
    if (birthdateInput) birthdateInput.addEventListener('change', updateFormDisplay);

    // Initial display update
    updateFormDisplay();

    // Handle date input placeholder visibility
    const dateInputs = formElement.querySelectorAll('input[type="date"]');
    dateInputs.forEach(dateInput => {
      const placeholder = dateInput.nextElementSibling;

      function updatePlaceholderVisibility() {
        if (dateInput.value) {
          dateInput.classList.add('has-value');
        } else {
          dateInput.classList.remove('has-value');
        }
      }

      // Check on load
      updatePlaceholderVisibility();

      // Check on change
      dateInput.addEventListener('change', updatePlaceholderVisibility);
      dateInput.addEventListener('input', updatePlaceholderVisibility);

      // Check on focus/blur (for iOS)
      dateInput.addEventListener('blur', updatePlaceholderVisibility);
    });

    // Form submission handler
    formElement.addEventListener('submit', function(e) {
      console.log('üöÄ Form submit event triggered - using native submission!');
      console.log('üìã Camp pricing radios found:', campPricingRadios.length);

      // Disable signUpFor field so it doesn't submit (UI-only field)
      signUpForRadios.forEach(radio => radio.disabled = true);

      // For camp forms: Append pricing parameter to redirect URL
      if (campPricingRadios.length > 0) {
        const selectedPricing = formElement.querySelector('input[name="campPricing"]:checked')?.value;
        console.log('üí∞ Selected pricing:', selectedPricing);
        if (selectedPricing) {
          const currentRedirectUrl = redirectField.value;
          const separator = currentRedirectUrl.includes('?') ? '&' : '?';
          const newRedirectUrl = `${currentRedirectUrl}${separator}pricing=${selectedPricing}`;
          redirectField.value = newRedirectUrl;
          console.log('üí∞ Current redirect URL:', currentRedirectUrl);
          console.log('üí∞ Updated redirect URL:', newRedirectUrl);
          console.log('üí∞ Redirect field value now:', redirectField.value);
        } else {
          console.warn('‚ö†Ô∏è No pricing option selected!');
        }
      }

      const submitButton = formElement.querySelector('button[type="submit"]');

      // Show loading state (form will submit naturally)
      if (submitButton) {
        submitButton.disabled = true;
        submitButton.textContent = form.submitButton.loading;
      }

      // Let the form submit naturally to Formspark
      // Formspark will handle the redirect using the _redirect hidden field
    });
  });
</script>